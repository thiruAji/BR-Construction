FIRESTORE SECURITY RULES - Copy this to Firebase Console

Go to: Firebase Console > construction-da7de > Firestore Database > Rules

Replace all content with this:

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - only users can read/write their own document
    match /users/{userId} {
      allow read: if request.auth.uid == userId || request.auth != null;
      allow write: if request.auth.uid == userId;
    }
    
    // Sites collection
    match /sites/{siteId} {
      // Anyone logged in can READ (view) all sites
      allow read: if request.auth != null;
      
      // Only CEO users can CREATE sites
      allow create: if request.auth != null && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CEO';
      
      // UPDATE permissions:
      // CEO can update everything in their sites
      // Members can update expenses and columns (non-CEO-protected fields)
      allow update: if request.auth != null && (
        // CEO who created the site - full access
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CEO' &&
         resource.data.createdBy == request.auth.uid) ||
        // Members can update expenseColumns (add columns) and other non-protected fields
        // But cannot update: name, location, ceoBudget, ceoProjectValue, createdBy, createdByEmail
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Member' &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['name', 'location', 'ceoBudget', 'ceoProjectValue', 'createdBy', 'createdByEmail']))
      );
      
      allow delete: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CEO' &&
                     resource.data.createdBy == request.auth.uid;
    }
    
    // Expenses subcollection under sites
    match /sites/{siteId}/expenses/{expenseId} {
      // Anyone can read expenses
      allow read: if request.auth != null;
      
      // CREATE: CEO and Members can both create expenses
      // UPDATE: 
      //   - CEO can update any field
      //   - Members can update fields not marked with createdByRole='CEO'
      // DELETE: Members can delete their own, CEO can delete any
      allow create: if request.auth != null;
      
      allow update: if request.auth != null && (
        // CEO can update everything
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CEO' ||
        // Members can only update non-CEO fields (handled by frontend, enforced here by checking field rules)
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Member'
      );
      
      allow delete: if request.auth != null && (
        // CEO creator can delete any expense
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CEO' &&
        get(/databases/$(database)/documents/sites/$(siteId)).data.createdBy == request.auth.uid ||
        // Members can delete their own expenses
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Member' &&
        resource.data.createdBy == request.auth.uid
      );
    }
  }
}
```

STEPS TO APPLY:
1. Go to https://console.firebase.google.com
2. Select project: construction-da7de
3. Click "Firestore Database" in left menu
4. Click "Rules" tab
5. Copy and paste the rules above
6. Click "Publish"
